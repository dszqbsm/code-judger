# 文件名：redis.conf
# 用途：Redis 7 缓存服务的性能优化配置文件
# 创建日期：2024-01-15
# 版本：v1.0
# 说明：针对在线判题系统的缓存需求优化，支持会话管理、排行榜、任务队列等场景
# 依赖：Redis 7+ 版本，适用于单机和小集群部署

# ===========================================
# 网络连接设置
# ===========================================
# 绑定地址，0.0.0.0允许所有网络接口访问
bind 0.0.0.0
# 监听端口，Redis默认端口
port 6379
# TCP连接队列长度，高并发时避免连接拒绝
tcp-backlog 511
# 客户端空闲超时时间，0=永不超时
timeout 0
# TCP连接保活时间（秒），检测断开的连接
tcp-keepalive 300

# ===========================================
# 服务进程设置
# ===========================================
# 前台运行模式，Docker容器中必须设为no
daemonize no
# 不使用系统supervisor管理
supervised no
# 进程ID文件路径
pidfile /var/run/redis_6379.pid
# 日志级别：debug < verbose < notice < warning
loglevel notice
# 日志文件路径，空字符串表示输出到stdout
logfile ""
# 数据库数量，默认16个数据库（db0-db15）
databases 16

# ===========================================
# RDB 快照持久化设置
# ===========================================
# 900秒内至少1个键改变时保存快照
save 900 1
# 300秒内至少10个键改变时保存快照
save 300 10
# 60秒内至少10000个键改变时保存快照
save 60 10000

# RDB保存失败时停止写入，保证数据一致性
stop-writes-on-bgsave-error yes
# 启用RDB文件压缩，节省磁盘空间
rdbcompression yes
# 启用RDB文件校验和，确保数据完整性
rdbchecksum yes
# RDB文件名称
dbfilename dump.rdb
# 数据文件存储目录
dir ./

# ===========================================
# AOF 追加日志持久化设置（推荐）
# ===========================================
# 启用AOF持久化，提供更好的数据安全性
appendonly yes
# AOF文件名称
appendfilename "appendonly.aof"
# AOF同步策略：always=最安全 everysec=平衡 no=最快
appendfsync everysec
# AOF重写时不停止同步，保证数据安全
no-appendfsync-on-rewrite no
# AOF文件大小增长100%时触发重写
auto-aof-rewrite-percentage 100
# AOF重写的最小文件大小阈值
auto-aof-rewrite-min-size 64mb
# 启动时加载被截断的AOF文件
aof-load-truncated yes
# AOF重写时使用RDB格式前缀，提高加载速度
aof-use-rdb-preamble yes

# ===========================================
# 内存管理和淘汰策略
# ===========================================
# 最大内存限制，防止内存溢出
maxmemory 256mb
# 内存淘汰策略：allkeys-lru=LRU淘汰所有键，适合缓存场景
maxmemory-policy allkeys-lru
# LRU算法采样数量，值越大越精确但越慢
maxmemory-samples 5

# ===========================================
# 性能监控设置
# ===========================================
# 慢查询阈值（微秒），记录超过10ms的命令
slowlog-log-slower-than 10000
# 慢查询日志最大长度，超出时移除最旧记录
slowlog-max-len 128

# ===========================================
# 客户端连接限制
# ===========================================
# 最大客户端连接数，适合高并发场景
maxclients 1000

# ===========================================
# 安全设置（开发环境）
# ===========================================
# requirepass your_redis_password          # 密码认证，生产环境建议启用
                                          # 开发环境为便于调试暂时禁用

# ===========================================
# 危险命令禁用（安全加固）
# ===========================================
# 禁用FLUSHDB命令，防止误删数据库
rename-command FLUSHDB ""
# 禁用FLUSHALL命令，防止误删所有数据
rename-command FLUSHALL ""
# 禁用DEBUG命令，防止调试信息泄露
rename-command DEBUG ""
# 禁用CONFIG命令，防止配置被恶意修改
rename-command CONFIG ""

# ===========================================
# 集群设置（当前为单机模式）
# ===========================================
# 以下配置在需要Redis集群时启用：
# cluster-enabled yes                      # 启用集群模式
# cluster-config-file nodes-6379.conf     # 集群配置文件
# cluster-node-timeout 15000              # 节点超时时间（毫秒）