# 文件名：my.cnf
# 用途：MySQL 8.0 数据库服务的性能优化配置文件
# 创建日期：2024-01-15
# 版本：v1.0
# 说明：针对在线判题系统的数据访问特点进行优化，平衡读写性能、并发连接和内存使用
# 依赖：MySQL 8.0+ 版本，适用于开发和小规模生产环境

# ===========================================
# MySQL 服务器配置段
# ===========================================
[mysqld]
# ===========================================
# 字符集和时区设置
# ===========================================
character-set-server = utf8mb4              # 服务器默认字符集，支持完整的Unicode字符
collation-server = utf8mb4_unicode_ci       # 排序规则，支持多语言排序和比较
default-time-zone = '+08:00'                # 默认时区设置为东八区（北京时间）
sql_mode = STRICT_TRANS_TABLES,NO_ZERO_DATE,NO_ZERO_IN_DATE,ERROR_FOR_DIVISION_BY_ZERO  # 严格模式，提高数据完整性

# ===========================================
# 连接和并发设置
# ===========================================
max_connections = 1000                      # 最大并发连接数，适合高并发OJ系统
max_connect_errors = 100000                 # 最大连接错误数，防止因网络问题被误封
wait_timeout = 28800                        # 连接空闲超时时间（8小时），适合长连接场景
interactive_timeout = 28800                 # 交互式连接超时时间，与wait_timeout保持一致

# ===========================================
# InnoDB 存储引擎优化（核心配置）
# ===========================================
innodb_buffer_pool_size = 256M              # 缓冲池大小，缓存数据和索引（建议为系统内存的70-80%）
innodb_log_file_size = 64M                  # 重做日志文件大小，影响写入性能和崩溃恢复时间
innodb_log_buffer_size = 16M                # 日志缓冲区大小，提高写入性能
innodb_flush_log_at_trx_commit = 1          # 事务提交时刷新日志策略：1=最安全，0=最快，2=平衡
innodb_file_per_table = 1                   # 每个表使用独立表空间，便于管理和优化
innodb_lock_wait_timeout = 50               # 锁等待超时时间（秒），防止长时间死锁

# ===========================================
# 查询性能优化
# ===========================================
# query_cache_type 和 query_cache_size 在 MySQL 8.0 中已移除
tmp_table_size = 64M                        # 内存临时表最大大小，超出后写入磁盘
max_heap_table_size = 64M                   # HEAP表最大大小，与tmp_table_size保持一致

# ===========================================
# 日志设置（性能分析和故障排查）
# ===========================================
slow_query_log = 1                          # 启用慢查询日志，用于性能优化
slow_query_log_file = /var/log/mysql/slow.log  # 慢查询日志文件路径
long_query_time = 2                         # 慢查询阈值（秒），超过2秒的查询被记录
log_queries_not_using_indexes = 0           # 不记录未使用索引的查询（开发时可设为1）

# ===========================================
# 二进制日志（复制和备份）
# ===========================================
server-id = 1                               # 服务器唯一ID，主从复制时必需
log-bin = mysql-bin                         # 二进制日志文件名前缀
binlog_format = ROW                         # 二进制日志格式：ROW=最安全，STATEMENT=最小，MIXED=自动
expire_logs_days = 7                        # 二进制日志保留天数，自动清理旧日志
max_binlog_size = 100M                      # 单个二进制日志文件最大大小

# ===========================================
# 安全设置
# ===========================================
local_infile = 0                            # 禁用LOAD DATA LOCAL INFILE，防止安全风险

# ===========================================
# MySQL 客户端配置段
# ===========================================
[mysql]
default-character-set = utf8mb4             # 客户端默认字符集

# ===========================================
# 通用客户端配置段
# ===========================================
[client]
default-character-set = utf8mb4             # 所有客户端工具默认字符集