# DeleteProblem 完整业务逻辑指南

## 概述

DeleteProblem方法已实现完整的JWT用户信息获取、权限验证、提交记录检查和配套清理功能，确保题目删除的安全性和数据一致性。

## 业务流程

### 1. 用户身份认证
- 从JWT令牌中提取用户信息（用户ID、用户名、角色等）
- 支持两种方式获取用户信息：
  - 从go-zero的JWT上下文获取
  - 从HTTP请求头的Authorization Bearer令牌获取

### 2. 权限验证规则
- **管理员 (admin)**：可以删除任何题目
- **教师 (teacher)**：只能删除自己创建的题目
- **学生 (student)**：无权限删除题目

### 3. 业务验证步骤
1. **题目ID验证**：检查题目ID是否有效
2. **用户认证**：验证JWT令牌并获取用户信息
3. **题目存在性检查**：验证题目是否存在且未被删除
4. **权限验证**：基于用户角色和题目创建者进行权限检查
5. **提交记录检查**：检查题目是否有相关提交记录，有则禁止删除
6. **软删除执行**：标记题目为删除状态
7. **配套清理**：清理相关资源和数据
8. **操作日志记录**：记录详细的操作日志

### 4. 配套清理功能
删除题目后会自动执行以下清理操作：

#### 4.1 测试用例文件清理
- 删除 `/data/testcases/problem_{id}/` 目录下的所有测试用例文件
- 包括输入文件、输出文件、配置文件等

#### 4.2 缓存清理
- 清理题目详情缓存：`problem:detail:{id}`
- 清理测试用例缓存：`problem:testcases:{id}`
- 清理题目列表缓存：`problem:list:*`
- 清理搜索结果缓存：`problem:search:*`

#### 4.3 关联数据清理
- 清理题目标签关联（如有独立标签表）
- 清理用户收藏记录（通过RPC调用用户服务）
- 清理题目统计数据（如有独立统计表）

#### 4.4 通知功能
- 通知收藏该题目的用户
- 发送系统消息或邮件通知
- 记录到审计日志

## 使用示例

### 1. 教师删除自己创建的题目

**请求头：**
```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json
```

**请求：**
```http
DELETE /api/v1/problems/1001
```

**成功响应：**
```json
{
  "code": 200,
  "message": "题目删除成功",
  "data": {
    "problem_id": 1001,
    "deleted_at": "2024-01-15T10:30:00Z",
    "message": "题目已被标记为删除状态，相关资源已清理"
  }
}
```

### 2. 尝试删除有提交记录的题目

**请求：**
```http
DELETE /api/v1/problems/1002
```

**错误响应：**
```json
{
  "code": 400,
  "message": "无法删除题目：该题目已有 15 条提交记录",
  "data": null
}
```

### 3. 权限不足的删除尝试

**请求：**
```http
DELETE /api/v1/problems/1003
```

**错误响应：**
```json
{
  "code": 403,
  "message": "权限不足：只能删除自己创建的题目",
  "data": null
}
```

## 安全特性

### 1. 多层权限验证
- JWT令牌验证
- 用户状态检查
- 角色权限验证
- 资源所有权验证

### 2. 数据保护
- 软删除机制，数据可恢复
- 提交记录保护，防止数据丢失
- 详细的操作审计日志

### 3. 资源清理
- 自动清理相关文件和缓存
- 跨服务数据一致性保证
- 用户通知机制

## 错误处理

### 常见错误码
- **400**：请求参数错误（无效ID、有提交记录等）
- **401**：认证失败（JWT令牌无效、过期等）
- **403**：权限不足（角色权限、资源所有权等）
- **404**：资源不存在（题目不存在、已删除等）
- **500**：服务器内部错误（数据库错误、文件系统错误等）

### 错误日志记录
所有错误都会记录详细的日志信息，包括：
- 用户信息（用户名、ID、角色）
- 操作信息（题目ID、标题）
- 错误详情（错误类型、错误消息）
- 时间戳和请求上下文

## 配置说明

### 测试用例存储路径
```yaml
# problem-api.yaml
Business:
  TestCaseBasePath: "/data/testcases"  # 测试用例基础路径
  TestCaseDirPattern: "problem_%d"     # 题目测试用例目录模式
```

### 缓存配置
```yaml
# problem-api.yaml
Cache:
  ProblemDetailPrefix: "problem:detail:"
  ProblemListPrefix: "problem:list:"
  TestCasePrefix: "problem:testcases:"
  SearchPrefix: "problem:search:"
```

## 开发注意事项

### 1. 跨服务调用
当前实现中，以下功能需要完善跨服务调用：
- 提交记录检查（需要调用submission-api）
- 用户收藏记录清理（需要调用user-api）
- 统计数据清理（需要调用statistics-api）

### 2. 异步处理
对于耗时的清理操作，建议使用异步处理：
- 文件删除操作
- 缓存清理操作
- 用户通知发送

### 3. 事务管理
建议将删除操作和关键清理操作包装在数据库事务中，确保数据一致性。

### 4. 监控和告警
建议添加以下监控指标：
- 删除操作频率
- 清理操作成功率
- 错误率和错误类型分布
- 响应时间监控

## 扩展功能

### 1. 批量删除
可以扩展支持批量删除题目功能，需要注意：
- 批量权限验证
- 批量提交记录检查
- 批量清理操作的性能优化

### 2. 删除确认机制
对于重要题目，可以添加二次确认机制：
- 删除前发送确认邮件
- 需要输入题目标题确认
- 管理员审批机制

### 3. 恢复功能
基于软删除机制，可以实现题目恢复功能：
- 恢复已删除的题目
- 恢复相关的测试用例文件
- 重建缓存数据

## 总结

DeleteProblem方法现在提供了完整的企业级删除功能，包括严格的权限验证、数据保护机制和完善的资源清理。通过多层验证和详细的日志记录，确保了操作的安全性和可追溯性。





